<script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.7.19/aws-sdk.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lockr/0.8.4/lockr.min.js"></script>
<script src="cloudy-gamer.js"></script>
<style>
  details {border: 1px solid black; padding: 5px; width: 600px; margin-bottom: 5px}
  details[open] > summary {margin-bottom: 5px}
  summary {cursor: pointer}
  summary:focus {outline: none}
</style>

cloudygamer - <a href="https://github.com/lg/cloudy-gamer/">github source and help</a><br/><br/>

<details id="aws-config-panel">
  <summary>AWS configuration</summary>
  <label for="awsAccessKey">AWS Access Key: </label><input type="text" id="awsAccessKey" value=""/><br/>
  <label for="awsSecretAccessKey">AWS Secret Access Key: </label><input type="text" id="awsSecretAccessKey" value=""/><br/>
  <label for="awsIAMRoleName">AWS EC2 IAM Role Name: </label><input type="text" id="awsIAMRoleName" value=""/><br/>
  <label for="awsRegionZone">AWS Region Zone: </label><input type="text" id="awsRegionZone" value=""/><br/>
  <button onclick="saveAndReloadCG()">save config</button>
  <button onclick="testMainConfig()">test/prep</button>
  <p style='font-size:50%'>
    Note 1: Use <a href='user-policy.txt' target='_blank'>this</a> policy for your AWS user<br/>
    Note 2: Your awsIAMRoleName needs at least the AmazonEC2RoleforSSM policy attached to it</a>
  </p>
</details>

<details id="volume-config-panel">
  <summary>Volume configuration</summary>
  <label for="awsVolumeName">AWS Volume Name: </label><input type="text" id="awsVolumeName" value=""/><br/>
  <button onclick="saveAndReloadCG()">save config</button><br/>
  <button onclick="provisionNewImage()">provision new image</button>
  <button onclick="updateProvisionStatus()">check status</button>
  <button onclick="terminateProvisioning()">terminate</button>
  <label for="provision">with password: </label><input type="text" id="provision" value=""/><br/>
</details>

<details id="control-panel">
  <summary>CloudyGamer control</summary>
  instance status: <span id='instance-status'>(unknown)</span><br/>
  volume status: <span id='volume-status'>(unknown)</span><br/>
  <button onclick="updateStatuses()">update status</button><br/>
  <br/>
  <button onclick="startInstance()">start instance</button>
  <button onclick="stopInstance()">stop instance</button><br/>
  <button onclick="cg.restartSteam()">restart steam</button><br/>
  <br/>
</details>

<span id='cur-status' style='font-size:75%'>&nbsp;</span><br/>

<script>
  self.provisionTimer = null
  self.config = {}

  start = () => {
    bindLockr("awsAccessKey", "")
    bindLockr("awsSecretAccessKey", "")
    bindLockr("awsIAMRoleName", "")
    bindLockr("awsRegionZone", "us-west-1c")
    bindLockr("awsVolumeName", "")
    saveAndReloadCG()

    if (!config.awsAccessKey || !config.awsSecretAccessKey || !config.awsSecretAccessKey || !config.awsRegionZone) {
      document.querySelector("#aws-config-panel").open = true
    } else if (!config.awsVolumeName) {
      document.querySelector("#volume-config-panel").open = true
    } else {
      document.querySelector("#control-panel").open = true
    }

    for (const panel of document.querySelectorAll("details")) {
      panel.ontoggle = (event) => {
        if (document.getElementById(event.srcElement.id).open) {
          if ((toClose = document.querySelector(`details:not(#${event.srcElement.id})[open]`)))
            toClose.open = false
        }
      }
    }
  }

  saveAndReloadCG = () => {
    for (const configName of Object.getOwnPropertyNames(self.config)) {
      if ((el = document.getElementById(configName)))
        self.config[configName] = el.value
    }
    self.cg = new CloudyGamer(self.config)
  }

  bindLockr = (configName, defaultValue) => {
    Object.defineProperty(self.config, configName, {
      set: (newVal) => {
        Lockr.set(configName, newVal)
      }, get: (defVal=defaultValue) => {
        return Lockr.get(configName, defVal)
      }
    })
    if ((el = document.getElementById(configName)))
      el.value = self.config[configName]
  }

  testMainConfig = async function() {
    await cg.discoverAndCreateResources()
  }

  startInstance = async function() {
    await self.cg.startInstance()
    updateStatuses()
  }

  stopInstance = async function() {
    await self.cg.stopInstance()
    updateStatuses()
  }

  terminateProvisioning = async function() {
    await self.cg.stopInstance()
    updateStatuses()
  }

  updateStatuses = () => {
    const instanceStatusEl = document.querySelector("#instance-status")
    const volumeStatusEl = document.querySelector("#volume-status")

    instanceStatusEl.textContent = "(retrieving)"
    volumeStatusEl.textContent = "(retrieving)"
    self.cg.getInstance().then(result => {
      self.cg.isInstanceOnline(result.InstanceId).then(isOnline => {
        const rdpUrl = `rdp://full%20address=s:${result.PublicIpAddress}:3389&username=s:cloudygamer&desktopwidth=i:1024&desktopheight=i:768`

        instanceStatusEl.innerHTML = `running (${result.InstanceId}, <a href='${rdpUrl}'>${result.PublicIpAddress}</a>, ${isOnline ? "online" : "offline"})`
      })
    }).catch(_ => {
      instanceStatusEl.textContent = "not running"
    })

    self.cg.isVolumeAvailable().then(result => {
      volumeStatusEl.textContent = result ? "available" : "in use"
    })
  }

  provisionNewImage = async function() {
    await self.cg.provisionNewImage(document.querySelector("#provision").value)
    self.provisionTimer = setInterval(self.updateProvisionStatus, 30000)
  }

  updateProvisionStatus = async function() {
    await self.cg.checkProvisionStatus(document.querySelector("#provision").value)
  }

  console.logCopy = console.log.bind(console)
  console.log = data => {
    console.logCopy(`%c${new Date().toISOString().replace(/[TZ]/g, " ")}%c${data}`, "color: gray", "")
    document.getElementById("cur-status").textContent = data
  }

  start()
</script>